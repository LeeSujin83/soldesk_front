name: Build and Deploy to ECR

on:
  push:
    branches: [ main ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
    - name: 소스 코드 체크아웃
      uses: actions/checkout@v2

    - name: 이미지 태그 (버전) 가져오기
      id: image
      run: |
        VERSION=$(echo ${GITHUB_SHA} | cut -c1-8)
        echo "VERSION=$VERSION"
        echo "::set-output name=version::$VERSION"

    - name: 로그인 Amazon ECR
      run: |
        aws ecr get-login-password --region ap-northeast-2 | docker login --username AWS --password-stdin YOUR_AWS_ACCOUNT_ID.dkr.ecr.ap-northeast-2.amazonaws.com
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

    - name: Docker 이미지 빌드 및 태그 지정
      run: |
        docker build -t ops-repo:${{ steps.image.outputs.version }} .
        docker tag ops-repo:${{ steps.image.outputs.version }} YOUR_AWS_ACCOUNT_ID.dkr.ecr.ap-northeast-2.amazonaws.com/ops-repo:${{ steps.image.outputs.version }}

    - name: Amazon ECR로 이미지 푸시
      run: |
        docker push YOUR_AWS_ACCOUNT_ID.dkr.ecr.ap-northeast-2.amazonaws.com/ops-repo:${{ steps.image.outputs.version }}
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

